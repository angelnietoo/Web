<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ejercicios — Funciones flecha y Map</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1726; --accent:#00b0ff; --muted:#c6d6e6;
      --success:#17b978; --danger:#ef4444;
      --radius:10px; --pad:12px; --soft:.18s;
    }
    *{box-sizing:border-box}
    body{
      font-family:Inter, system-ui, Arial;
      margin:0; min-height:100vh;
      background:linear-gradient(180deg,#071223 0%, #071026 60%);
      color:#eaf6ff; padding:28px; display:flex; justify-content:center;
    }
    .container{width:100%;max-width:1000px;display:grid;grid-template-columns:1fr 380px;gap:20px;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:18px; border-radius:var(--radius); border:1px solid rgba(255,255,255,0.03)}
    h1{margin:0 0 8px 0;font-size:1.25rem}
    label{display:block;font-size:.9rem;color:var(--muted);margin-bottom:6px}
    input[type="text"], input[type="number"]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    button{cursor:pointer;padding:10px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent),#007acb);color:#04202c;font-weight:700}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .grid{display:grid;gap:10px}
    .row{display:flex;gap:10px}
    .list{max-height:420px;overflow:auto;padding:8px;border-radius:8px;background:rgba(255,255,255,0.015);border:1px solid rgba(255,255,255,0.02)}
    .city-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:6px}
    .city-name{font-weight:800}
    .controls{display:flex;gap:8px;align-items:center}
    .small-btn{padding:6px 8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .info{font-size:.95rem;color:var(--muted);margin-top:8px}
    .max { color: var(--danger); font-weight:900; }
    .min { color: var(--success); font-weight:900; }
    .muted { color: var(--muted) }
    .danger { color: var(--danger) }
    .success { color: var(--success) }

    /* micro-animaciones para botones y foco */
    button, .small-btn { transition: transform var(--soft) cubic-bezier(.2,1,.36,1), box-shadow var(--soft) }
    button:hover, .small-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,176,255,0.06) }
    .hint { font-size:.85rem; color:var(--muted) }
    @media (max-width:980px){ .container{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <main class="container">
    <!-- IZQUIERDA: ejercicios -->
    <section class="card">
      <h1>1) Función flecha aleatoria</h1>
      <div class="grid">
        <label for="randMax">Introduce un número entero (n):</label>
        <input id="randMax" type="number" min="1" value="6" />
        <div class="row">
          <button id="btnRandom">Generar aleatorio entre 1 y n</button>
          <button class="btn-ghost" id="btnRandomClear">Borrar salida</button>
        </div>
        <div class="info">Resultado: <span id="randomResult" class="muted">—</span></div>
        <hr style="opacity:.06;border:none;height:1px;background:rgba(255,255,255,0.03)">

        <h1>2) Calculadora (funciones flecha)</h1>
        <label>Valores:</label>
        <div class="row">
          <input id="calcA" type="number" placeholder="a" />
          <input id="calcB" type="number" placeholder="b" />
        </div>
        <div class="row" style="margin-top:8px">
          <button id="addBtn">+</button>
          <button id="subBtn">-</button>
          <button id="mulBtn">*</button>
          <button id="divBtn">/</button>
        </div>
        <div class="info">Resultado: <span id="calcResult" class="muted">—</span></div>
      </div>
    </section>

    <!-- DERECHA: Map ciudades -->
    <aside class="card">
      <h1>3) Ciudades (Map)</h1>
      <div class="grid">
        <div>
          <label>Agregar ciudad</label>
          <input id="cityName" type="text" placeholder="Nombre ciudad" />
          <input id="cityPop" type="number" placeholder="Habitantes (ej. 50000)" />
          <div class="row" style="margin-top:8px">
            <button id="addCityBtn">Añadir ciudad</button>
            <button class="btn-ghost" id="clearCitiesBtn">Vaciar</button>
          </div>
        </div>

        <div style="margin-top:8px;">
          <div class="row">
            <button id="showAllBtn" class="small-btn">Ver todas</button>
            <button id="countBtn" class="small-btn">Contar ciudades</button>
            <button id="maxBtn" class="small-btn">Ciudad más poblada</button>
            <button id="minBtn" class="small-btn">Ciudad menos poblada</button>
          </div>
          <div class="info">Ciudades: <span id="cityCount" class="muted">0</span></div>
        </div>

        <div class="list" id="citiesList" aria-live="polite"></div>

        <div class="info hint">Haz click en "Ciudad más poblada" o "Ciudad menos poblada" para resaltar.</div>
      </div>
    </aside>
  </main>

  <script>
    /***************
     * 1) Función flecha aleatoria
     * Definida como const para poder reutilizarla.
     ***************/
    const getRandomBetween1And = (n) => {
      const max = Math.floor(Number(n));
      if (!Number.isFinite(max) || max <= 0) return null;
      // Math.floor(Math.random() * max) + 1 -> 1..max
      return Math.floor(Math.random() * max) + 1;
    };

    // DOM refs
    const randMaxEl = document.getElementById('randMax');
    const randomResult = document.getElementById('randomResult');
    document.getElementById('btnRandom').addEventListener('click', () => {
      const n = parseInt(randMaxEl.value, 10);
      const r = getRandomBetween1And(n);
      randomResult.textContent = r === null ? 'Parámetro inválido' : r;
    });
    document.getElementById('btnRandomClear').addEventListener('click', () => randomResult.textContent = '—');

    /***************
     * 2) Calculadora con funciones flecha
     ***************/
    const add = (a,b) => a + b;
    const sub = (a,b) => a - b;
    const mul = (a,b) => a * b;
    const div = (a,b) => b === 0 ? '∞ (div/0)' : a / b;

    const calcA = document.getElementById('calcA');
    const calcB = document.getElementById('calcResult') ? document.getElementById('calcB') : document.getElementById('calcB'); // guardamos siempre ref
    const calcResult = document.getElementById('calcResult');

    // botones
    document.getElementById('addBtn').addEventListener('click', () => {
      const a = Number(calcA.value || 0);
      const b = Number(document.getElementById('calcB').value || 0);
      calcResult.textContent = add(a,b);
    });
    document.getElementById('subBtn').addEventListener('click', () => {
      const a = Number(calcA.value || 0);
      const b = Number(document.getElementById('calcB').value || 0);
      calcResult.textContent = sub(a,b);
    });
    document.getElementById('mulBtn').addEventListener('click', () => {
      const a = Number(calcA.value || 0);
      const b = Number(document.getElementById('calcB').value || 0);
      calcResult.textContent = mul(a,b);
    });
    document.getElementById('divBtn').addEventListener('click', () => {
      const a = Number(calcA.value || 0);
      const b = Number(document.getElementById('calcB').value || 0);
      calcResult.textContent = div(a,b);
    });

    /***************
     * 3) Map de ciudades
     ***************/
    const STORAGE_KEY = 'ciudades_map_v1';

    // inicializamos Map con datos de ejemplo o desde localStorage
    const loadMapFromStorage = () => {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        // datos por defecto
        return new Map([
          ['Madrid', 3223000],
          ['Barcelona', 1620000],
          ['Sevilla', 688711],
          ['Valencia', 794288],
        ]);
      }
      try {
        const arr = JSON.parse(raw);
        return new Map(arr);
      } catch (e) {
        console.warn('No se pudo parsear localStorage, cargando por defecto', e);
        return new Map();
      }
    };

    const saveMapToStorage = (map) => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(map.entries())));
    };

    const citiesMap = loadMapFromStorage();

    // refs
    const cityNameInput = document.getElementById('cityName');
    const cityPopInput = document.getElementById('cityPop');
    const addCityBtn = document.getElementById('addCityBtn');
    const clearCitiesBtn = document.getElementById('clearCitiesBtn');
    const citiesList = document.getElementById('citiesList');
    const cityCount = document.getElementById('cityCount');
    const showAllBtn = document.getElementById('showAllBtn');
    const countBtn = document.getElementById('countBtn');
    const maxBtn = document.getElementById('maxBtn');
    const minBtn = document.getElementById('minBtn');

    // renderiza la lista en el DOM desde el Map
    const renderCities = (highlight = { type: null, key: null }) => {
      citiesList.innerHTML = '';
      if (citiesMap.size === 0) {
        citiesList.innerHTML = '<div class="muted">No hay ciudades añadidas.</div>';
      } else {
        citiesMap.forEach((pop, name) => {
          const item = document.createElement('div');
          item.className = 'city-item';
          const left = document.createElement('div');
          left.innerHTML = `<div class="city-name">${escapeHtml(name)}</div><div class="muted">${formatNumber(pop)} hab.</div>`;
          // aplicamos highlight si corresponde
          if (highlight.type === 'max' && highlight.key === name) left.querySelector('.city-name').classList.add('max');
          if (highlight.type === 'min' && highlight.key === name) left.querySelector('.city-name').classList.add('min');

          const right = document.createElement('div');
          right.className = 'controls';
          const del = document.createElement('button');
          del.className = 'small-btn';
          del.textContent = 'Borrar';
          del.title = `Borrar ${name}`;
          del.addEventListener('click', () => {
            if (!confirm(`¿Borrar la ciudad "${name}"?`)) return;
            citiesMap.delete(name);
            saveMapToStorage(citiesMap);
            renderCities();
            updateCount();
          });

          right.appendChild(del);
          item.appendChild(left);
          item.appendChild(right);
          citiesList.appendChild(item);
        });
      }
    };

    // escapado simple para evitar XSS con nombres
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
    }

    function formatNumber(n) {
      return n.toLocaleString('es-ES');
    }

    const updateCount = () => {
      cityCount.textContent = citiesMap.size;
    };

    // añadir ciudad (validaciones)
    addCityBtn.addEventListener('click', () => {
      const name = (cityNameInput.value || '').trim();
      const pop = Number(cityPopInput.value);
      if (!name) return alert('Introduce un nombre de ciudad válido.');
      if (!Number.isFinite(pop) || pop < 0) return alert('Introduce un número de habitantes válido (>= 0).');
      citiesMap.set(name, Math.floor(pop));
      saveMapToStorage(citiesMap);
      cityNameInput.value = '';
      cityPopInput.value = '';
      renderCities();
      updateCount();
    });

    clearCitiesBtn.addEventListener('click', () => {
      if (!confirm('¿Vaciar todas las ciudades?')) return;
      citiesMap.clear();
      saveMapToStorage(citiesMap);
      renderCities();
      updateCount();
    });

    // mostrar todas (simplemente renderiza)
    showAllBtn.addEventListener('click', () => { renderCities(); });

    // contar
    countBtn.addEventListener('click', () => {
      alert(`Hay ${citiesMap.size} ciudad(es) almacenada(s).`);
      updateCount();
    });

    // encontrar max y min
    const findMaxCity = () => {
      if (citiesMap.size === 0) return null;
      let maxKey = null, maxVal = -Infinity;
      for (const [k,v] of citiesMap.entries()) {
        if (v > maxVal) { maxVal = v; maxKey = k; }
      }
      return { key: maxKey, value: maxVal };
    };
    const findMinCity = () => {
      if (citiesMap.size === 0) return null;
      let minKey = null, minVal = Infinity;
      for (const [k,v] of citiesMap.entries()) {
        if (v < minVal) { minVal = v; minKey = k; }
      }
      return { key: minKey, value: minVal };
    };

    maxBtn.addEventListener('click', () => {
      const max = findMaxCity();
      if (!max) return alert('No hay ciudades.');
      renderCities({ type: 'max', key: max.key });
      alert(`Ciudad más poblada: ${max.key} (${formatNumber(max.value)} hab.)`);
    });
    minBtn.addEventListener('click', () => {
      const min = findMinCity();
      if (!min) return alert('No hay ciudades.');
      renderCities({ type: 'min', key: min.key });
      alert(`Ciudad menos poblada: ${min.key} (${formatNumber(min.value)} hab.)`);
    });

    // inicialización
    renderCities();
    updateCount();

    // pequeña utilidad: actualizar render si localStorage cambia en otra pestaña
    window.addEventListener('storage', (e) => {
      if (e.key === STORAGE_KEY) {
        const newMap = loadMapFromStorage();
        // limpiar/transferir
        citiesMap.clear();
        for (const [k,v] of newMap.entries()) citiesMap.set(k,v);
        renderCities();
        updateCount();
      }
    });
  </script>
</body>
</html>
